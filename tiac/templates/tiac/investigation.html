{% extends "tiac/base.html" %}
{% load dsfr_tags widget_tweaks static render_field_with_inline_label %}
{% block extrahead %}
    <link rel="stylesheet" href="{% static 'core/_etablissement_card.css' %}">
    <link rel="stylesheet" href="{% static 'tiac/investigation.css' %}">
    <link rel="stylesheet" href="{% static 'ssa/_custom_tree_select.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/treeselectjs@0.13.1/dist/treeselectjs.css" />
{% endblock %}

{% block content %}
    <form class="fr-container--fluid fr-background-alt--grey" method="post">
        {% csrf_token %}
        <main class="main-container">
            <div class="evenement-produit-form-header fr-grid-row">
                <h1 class="fr-col-6">Création d'une investigation de TIAC</h1>
                <div class="fr-col-6 fr-mb-auto fr-grid-row fr-grid-row--right">
                    {% if form.investigation_form.instance and form.investigation_form.instance.is_draft %}
                        <button type="submit" name="action" value="draft" class="fr-btn fr-btn--secondary fr-mr-2w">
                            Enregistrer le brouillon
                        </button>
                    {% endif %}
                    <button id="submit_publish" type="submit" name="action" value="publish" class="fr-btn">
                        {% if form.investigation_form.instance.pk %}Enregistrer{% else %}Publier{% endif %}
                    </button>
                </div>
            </div>

            {% if form.investigation_form.non_field_errors %}
                <section class="fr-my-4v fr-input-group fr-input-group--error">
                    {{ form.investigation_form.non_field_errors }}
                </section>
            {% endif %}

            <fieldset class="fr-fieldset form-fieldset">
                <legend class="fr-fieldset__legend fr-h3">Le contexte</legend>

                <div class="fr-grid-row fr-grid-row--gutters fr-col">
                    <div class="fr-col-12 fr-col-lg-4">
                        <div class="fr-input-group">
                            <label class="fr-label" for="date-creation-input">Date de création</label>
                            <input type="text" id="date-creation-input" class="fr-input" value="{% if form.investigation_form.instance.date_creation %}{{ form.investigation_form.instance.date_creation|date:"d/m/Y" }}{% else %}{% now 'd/m/Y' %}{% endif %}" disabled>
                        </div>
                        {% dsfr_form_field form.investigation_form.date_reception %}
                        {% dsfr_form_field form.investigation_form.evenement_origin %}
                        {% dsfr_inline_radio_field form.investigation_form.modalites_declaration %}
                    </div>

                    <div class="fr-col-12 fr-col-lg-4">
                        {% dsfr_form_field form.investigation_form.contenu %}
                    </div>

                    <div class="fr-col-12 fr-col-lg-4">
                        {% dsfr_inline_radio_field form.investigation_form.notify_ars %}
                        {% dsfr_inline_radio_field form.investigation_form.will_trigger_inquiry %}
                        {% dsfr_form_field form.investigation_form.numero_sivss %}
                        {% dsfr_form_field form.investigation_form.type_evenement %}
                    </div>
                </div>
            </fieldset>


            <fieldset class="fr-fieldset form-fieldset fr-mt-4v cas-fieldset">
                <legend class="fr-fieldset__legend fr-h3">Cas</legend>
                <div class="fr-grid-row fr-grid-row--gutters fr-col">
                    <div class="fr-col-12 fr-col-lg-2">
                        {% dsfr_form_field form.investigation_form.nb_sick_persons %}
                    </div>
                    <div class="fr-col-12 fr-col-lg-2">
                        {% dsfr_form_field form.investigation_form.nb_sick_persons_to_hospital %}
                    </div>
                    <div class="fr-col-12 fr-col-lg-2">
                        {% dsfr_form_field form.investigation_form.nb_dead_persons %}
                    </div>
                    <div class="fr-col-12 fr-col-lg-3">
                        {% dsfr_form_field form.investigation_form.datetime_first_symptoms %}
                    </div>
                    <div class="fr-col-12 fr-col-lg-3">
                        {% dsfr_form_field form.investigation_form.datetime_last_symptoms %}
                    </div>
                </div>

            </fieldset>

            <fieldset class="fr-fieldset form-fieldset fr-mt-4v form-fieldset" data-controller="etiologie-form" data-etiologie-form-selected-values-value='[]'>

                <div class="fieldset-header">
                    <legend class="fr-fieldset__legend fr-h3">Étiologie</legend>
                    <button
                        type="button"
                        class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line fr-mb-2w"
                        data-action="etiologie-form#onShowFirstModal:prevent:stop"
                        data-testid="add-etiologie"
                    >
                        Ajouter
                    </button>
                </div>

                <div class="fr-mb-2v">Dangers syndromiques suspectés</div>
                <script data-etiologie-form-target="jsonConfig" type="application/json">
                    {{ dangers_json|safe }}
                </script>
                <div class="etiologie-card-container fr-p-4w fr-mb-4w" data-etiologie-form-target="etiologieEmptyCardContainer">
                    <span class="fr-hint-text">Aucun danger syndromique suspecté n'est enregistré</span>
                </div>
                <div data-etiologie-form-target="etiologieCardContainer">
                </div>

                {% include "tiac/_etilogie_modal.html" %}
                {% include "tiac/_etilogie_modal_confirmation.html" %}
                {% dsfr_form_field form.investigation_form.danger_syndromiques_suspectes|set_data:"etiologie-form-target:hiddenField" %}
                {% for danger in dangers %}
                    {% include "tiac/_etilogie_template.html" with id=danger.html_id titre=danger.name_display help_text=danger.help_text description=danger.description %}
                {% endfor %}

                {% dsfr_form_field form.investigation_form.analyses_sur_les_malades|dsfr_inline %}
                <div class="fr-grid-row fr-grid-row--gutters fr-col">
                    <div class="fr-col-12 fr-col-lg-6">
                        {% dsfr_form_field form.investigation_form.precisions %}
                    </div>
                </div>


            </fieldset>
            <fieldset class="fr-fieldset form-fieldset fr-mt-4v">
                <h3 class="fr-fieldset__legend fr-h3">Éléments de l'investigation</h3>
                <div>
                    {% dsfr_notice title="Pour les TIAC confirmées ou fortement suspectées, seul l'enregistrement des éléments conclusifs est requis.<br/> Vous pouvez ajouter d'autres éléments si cela vous aide dans l'investigation (ces données ne seront pas valorisées dans les bilans nationaux)" %}
                </div>
                {{ form.repas_formset }}
                {{ form.aliment_formset }}
            </fieldset>

        </main>
    </form>
{% endblock %}
