{% extends 'sv/base.html' %}

{% load static %}
{% load etat_tags %}

{% block extrahead %}
    <link rel="stylesheet" href="{% static 'sv/fichedetection_form.css' %}">


{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'sv/fichedetection_form.js' %}"></script>
{% endblock %}

{% block content %}
    <main>
        {{ form.instance.free_link_ids|json_script:"free-links-id" }}
        {{ lieux|json_script:"lieux-json" }}
        {{ prelevements|json_script:"prelevements" }}
        {{ structures_preleveurs|json_script:"structures-preleveurs" }}
        {{ status_to_organisme_nuisible|json_script:"status-to-organisme-nuisible-id" }}

        <form action="{% if is_creation %}{% url 'fiche-detection-creation' %}{% else %}{% url 'fiche-detection-modification' form.instance.id  %}{% endif %}" method="post">
            {% csrf_token %}

            <div id="fiche-detection-form-header">
                <div>
                    <h1>
                        {% if is_creation %}
                            Création d'une fiche détection
                        {% else %}
                            Modification de la fiche détection n°<span x-text="ficheDetection.numero" x-model="ficheDetection.numero"></span>
                        {% endif %}
                    </h1>
                    {% if not is_creation %}
                        <p class="fr-badge fr-badge--{{fichedetection.etat.libelle|etat_fiche_color}} fr-badge--no-icon">{{ fichedetection.etat }}</p>
                        <p class="fr-badge fr-badge--no-icon">{{ fichedetection.visibilite }}</p>
                    {% endif %}
                </div>

                <p>
                    {% if is_creation %}
                        <input type="submit" name="action" value="Enregistrer le brouillon" data-action="brouillon" class="fr-btn fr-btn--secondary fr-mr-2w">
                        <input type="submit" name="action" value="Publier" data-action="publier" class="fr-btn">
                    {% else %}
                        <a href="{% url 'fiche-detection-vue-detaillee' fichedetection.pk %}" class="fr-link fr-mr-3w">Annuler</a>
                        <input type="submit" name="action" value="Enregistrer les modifications" data-action="enregistrer-modifications" class="fr-btn" data-testid="fiche-detection-save-btn">
                    {% endif %}
                </p>
            </div>

            <div id="fiche-detection-form">
                <div id="informations">
                    <h2>Informations</h2>
                    <div id="informations-content">
                        <div id="date-creation">
                            <label class="fr-label" for="date-creation-input">Date de création</label>
                            <input type="text" id="date-creation-input" class="fr-input" value="{% now 'd/m/Y' %}" disabled>
                        </div>
                        <div id="statut-evenement">
                            <label class="fr-label" for="statut-evenement-input">Statut évènement</label>
                            {{ form.statut_evenement }}
                        </div>
                        <div id="numero-europhyt" {% if not user.agent.structure.is_ac %}class="fr-hidden"{% endif %}>
                            <label class="fr-label" for="numero-europhyt-input">Numéro Europhyt</label>
                            {{ form.numero_europhyt }}
                        </div>
                        <div id="numero-rasff" {% if not user.agent.structure.is_ac %}class="fr-hidden"{% endif %}>
                            <label class="fr-label" for="numero-rasff-input">Numéro Rasff</label>
                            {{ form.numero_rasff }}
                        </div>
                    </div>
                </div>

                <div id="objet-evenement">
                    <h2>Objet de l'évènement</h2>
                    <p id="organisme-nuisible">
                        <label class="fr-label" for="organisme-nuisible-input">Organisme nuisible</label>
                        {{ form.organisme_nuisible }}
                    </p>
                    <p id="statut-reglementaire">
                        <label class="fr-label" for="statut-reglementaire-input">Statut règlementaire</label>
                        {{ form.statut_reglementaire }}
                    </p>
                    <p id="contexte">
                        <label class="fr-label" for="contexte-input">Contexte</label>
                        {{ form.contexte }}
                    </p>
                    <p id="date-1er-signalement">
                        <label class="fr-label" for="date-1er-signalement-input">Date 1er signalement</label>
                        {{ form.date_premier_signalement }}
                    </p>
                    <p>
                        <label class="fr-label" for="vegetaux-infestes-input">Végétaux infestés</label>
                        {{ form.vegetaux_infestes }}
                    </p>
                    <p>
                        <label class="fr-label" for="commentaire-input">Commentaire</label>
                        {{ form.commentaire }}
                    </p>
                </div>

                <div id="lieux">
                    <div id="lieux-header">
                        <h2>Lieux</h2>
                        <button type="button" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line"
                                id="add-lieu-bouton"
                                data-fr-opened="false" aria-controls="modal-add-edit-lieu">Ajouter</button>
                    </div>


                    {{ lieu_formset.management_form }}
                    {% for form in lieu_formset %}
                        {% if form.instance.pk %}
                            {{ form.id }}
                        {% endif %}
                    {% endfor %}


                    <template x-if="lieux.length == 0">
                        <p>Aucun lieu.</p>
                    </template>
                    {% include 'sv/_fichedetection_form__lieux.html' %}


                </div>

                <div id="prelevements">
                    <div id="prelevements-header">
                        <h2>Prélèvements</h2>
                        <template x-if="lieux.length > 0">
                            <button type="button" @click="addPrelevementForm()" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line"
                                    data-fr-opened="false" aria-controls="modal-add-edit-prelevement">Ajouter</button>
                        </template>
                        <template x-if="lieux.length == 0">
                            <button type="button" class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-add-line" disabled>Ajouter</button>
                        </template>
                    </div>
                    <template x-if="lieux.length == 0">
                        <p>Aucun prélèvement. Pour ajouter une prélèvement vous devez avoir renseigné au moins un lieu.</p>
                    </template>

                    {% include 'sv/_fichedetection_form__prelevements.html' %}
                </div>

                <div id="mesures-gestion">
                    <h2>Mesures de gestion</h2>
                    <div id="mesures-gestion-content">
                        <p id="mesures-conservatoires-immediates">
                            <label class="fr-label" for="mesures-conservatoires-immediates-input">Mesures conservatoires immédiates</label>
                            {{ form.mesures_conservatoires_immediates }}
                        </p>
                        <p id="mesures-consignation">
                            <label class="fr-label" for="mesures-consignation-input">Mesures de consignation</label>
                            {{ form.mesures_consignation }}
                        </p>
                        <p id="mesures-phytosanitaires">
                            <label class="fr-label" for="mesures-phytosanitaires-input">Mesures phytosanitaires</label>
                            {{ form.mesures_phytosanitaires }}
                        </p>
                        <p id="mesures-surveillance-specifique">
                            <label class="fr-label" for="mesures-surveillance-specifique-input">Mesures de surveillance spécifique</label>
                            {{ form.mesures_surveillance_specifique }}
                        </p>
                    </div>
                </div>

                <div id="liens-libre" class="white-container fr-mt-4w">
                    <h2>Liens libres</h2>
                    <div>
                        {{ form.free_link }}
                    </div>
                </div>
            </div>
        </form>

	<!-- Modal ajout/modif lieu -->
        {% include 'sv/_fichedetection_form__lieux_form.html'%}
        {% include 'sv/_fiche_detection_lieu_template.html' with form=lieu_empty_form  %}

        <template id="lieu-carte">
            <div class="lieu-initial">
                <div class="lieu-header">
                    <p x-text="lieu.nomLieu" class="lieu-nom"></p>
                    <p x-text="lieu.commune" class="lieu-commune"></p>
                </div>
            </div>
        </template>

	<!-- Modal ajout/modif prélèvement -->
        {% include 'sv/_fichedetection_form__prelevements_form.html' %}
    </main>
{% endblock %}
