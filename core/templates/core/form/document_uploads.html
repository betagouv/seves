{% load dsfr_tags partials stimulus widget_tweaks %}

<div
    data-controller="document-formset"
    data-document-formset-next-url-value="{{ formset.next_url }}"
    data-document-formset-generic-error-value="Vous pouvez consulter ci-dessous les fichiers problématiques (intitulé en rouge) avant de réessayer."
    data-document-formset-dragging-class="document-upload-drag-drop--dragging"
    data-document-formset-upload-disabled-class="document-upload-drag-drop--disabled"
    data-document-formset-loading-class="document-modal--loading"
    data-document-formset-allowed-extensions-value="{{ formset.allowed_extensions_per_document_type }}"
    data-document-formset-document-form-outlet="[data-controller='document-form']"
>
    <template data-document-formset-target="successMessageTpl">
        <div
            id="document-upload-messages"
            class="fr-alert fr-alert--success fr-alert--sm"
            data-controller="dismissable-alert"
        >
            <h3 class="fr-alert__title">
                Les fichiers suivants ont été ajoutés avec succès et seront disponibles après l'analyse antivirus :
            </h3>
            <ul>__html__</ul>
            <button
                title="Masquer le message"
                type="button"
                class="fr-btn--close fr-btn"
                data-dismissable-alert-target="close"
            >
                Masquer le message
            </button>
        </div>
    </template>

    <dialog
        id="document-modal"
        class="fr-modal fr-modal--top"
        aria-labelledby="document-modal-title"
        data-fr-concealing-backdrop="false"
        data-action="dsfr.conceal->document-formset#onModalClose:self"
        data-document-formset-target="modal"
    >
        <div class="fr-container fr-container--fluid fr-container-lg">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-lg-10">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button
                                aria-controls="document-modal"
                                title="Fermer"
                                type="button"
                                id="document-modal-close-btn"
                                class="fr-btn--close fr-btn"
                            >Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <hgroup>
                                <h2 id="document-modal-title" class="fr-modal__title">
                                    <span class="fr-icon-arrow-right-line fr-icon--lg" aria-hidden="true"></span>
                                    Ajouter des documents
                                </h2>
                                <p class="fr-hint-text">
                                    Formats supportés :
                                    <span data-document-formset-target="allowedExtensions">
                                        {{ formset.allowed_extensions|join:", " }}
                                    </span><br>
                                    Taille maximale autorisée : {{ formset.max_upload_size_mb }} Mo
                                </p>
                            </hgroup>

                            <div class="fr-select-group">
                                <label class="fr-label" for="document-upload-type-all">
                                    <span class="label-marked">Type de document</span>
                                    <span class="fr-hint-text fr-text--regular fr-text-default--info">
                                        Le même type sera appliqué à tous les documents puis vous pourrez modifier individuellement
                                    </span>
                                </label>
                                <select
                                    id="document-upload-type-all"
                                    class="fr-select"
                                    data-action="document-formset#onChangeType:prevent:stop"
                                    data-document-formset-target="fileType"
                                >
                                    {% for subwidget in formset.empty_form.document_type.subwidgets %}
                                        {{ subwidget }}
                                    {% endfor %}
                                </select>
                            </div>

                            <section
                                class="document-upload-drag-drop"
                                data-document-formset-target="documentModalDragDropContainer"
                            >
                                <div
                                    class="document-upload-drag-drop--zone"
                                    data-document-formset-target="documentModalDragDrop"
                                    data-action="dragover->document-formset#onDragOver
                                                 drop->document-formset#onDrop:prevent:stop
                                                 dragenter->document-formset#onDragEnter:prevent:stop
                                                 dragleave->document-formset#onDragLeave:prevent:stop
                                                 dragend->document-formset#onDragLeave:prevent:stop"
                                >

                                    <p class="fr-m-0">
                                        Glissez vos fichiers ici ou
                                        <label
                                            class="fr-label upload-btn"
                                            for="filechooser-btn"
                                            tabindex="0"
                                        >cliquez pour les selectionner</label>
                                        <input
                                            id="filechooser-btn"
                                            class="fr-sr-only"
                                            type="file"
                                            multiple
                                            data-action="document-formset#onFileSelect:prevent:stop"
                                            data-document-formset-target="documentFile"
                                            data-testid="filechooser-link"
                                        />
                                    </p>
                                </div>

                                <section class="fr-mx-8v">
                                    <div
                                        class="fr-alert fr-alert--error fr-mb-6v"
                                        data-document-formset-target="errorContainer"
                                        data-controller="dismissable-alert"
                                        data-dismissable-alert-hide="true"
                                        {% if not form.errors %}hidden{% endif %}
                                    >
                                        <h3 class="fr-alert__title">Le formulaire contient des erreurs.</h3>
                                        <p>
                                            Vous pouvez consulter ci-dessous les fichiers problématiques
                                            (intitulé en rouge) avant de réessayer.
                                        </p>
                                        <button
                                            type="button" class="fr-btn--close fr-btn" title="Masquer le message"
                                            data-dismissable-alert-target="close"
                                        >
                                            Masquer le message
                                        </button>
                                    </div>
                                    <div
                                        class="document-upload-drag-drop--accordion-container"
                                        data-document-formset-target="formsetContainer"
                                    >
                                        {% for form in formset %}
                                            {{ form }}
                                        {% endfor %}
                                    </div>
                                </section>
                            </section>

                            <section class="fr-btns-group fr-btns-group--inline fr-btns-group--right fr-btns-group--icon-left fr-mt-6v fr-mb-n4v">
                                <button
                                    class="fr-btn"
                                    type="submit"
                                    data-action="document-formset#onSubmit:prevent:stop"
                                    data-document-formset-target="submitBtn"
                                    data-testid="document-submit-btn"
                                >
                                    Ajouter
                                </button>
                            </section>

                            <template data-document-formset-target="emptyFormTpl">
                                {{ formset.empty_form }}
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
</div>
